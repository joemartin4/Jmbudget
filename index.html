<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aplicaci√≥n web para gesti√≥n de presupuesto familiar con categor√≠as, transacciones y reportes detallados">
    <meta name="keywords" content="presupuesto, finanzas, hogar, gastos, ingresos, categor√≠as">
    <meta name="author" content="JM Budget">
    <meta name="robots" content="index, follow">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="apple-touch-icon-precomposed" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    
    <title>JM Budget - Gesti√≥n de Presupuesto Familiar</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css?v=1.0.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="chart-config.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Configuraci√≥n global de Firebase -->
    <script src="firebase-config.js"></script>
    
    <!-- Configuraci√≥n de Firebase para Desarrollo -->
    <script src="firebase-dev-config.js"></script>
    
    <!-- Inicializaci√≥n de Firebase -->
    <script src="firebase-init.js"></script>
    
    <!-- Configuraci√≥n de la aplicaci√≥n -->
    <script src="config.js"></script>
    
    <!-- Configuraci√≥n de rendimiento -->
    <script src="performance-config.js"></script>
    
    <!-- Manejador de errores -->
    <script src="error-handler.js"></script>
    
    <!-- Servicio de Autenticaci√≥n -->
    <script src="auth-service.js"></script>
    
    <!-- Servicio de Sincronizaci√≥n -->
    <script src="sync-service.js"></script>
    
    <!-- Servicio de Notificaciones -->
    <script src="notification-service.js"></script>
    
    <!-- Servicio de Temas -->
    <script src="theme-service.js"></script>
</head>
<body>
    <!-- Sistema de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-wallet"></i>
                <h1>JM Budget</h1>
                <p>Gesti√≥n de Presupuesto Familiar</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Ingresa tu email" required>
                    <div class="validation-message" id="emailValidation"></div>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <div class="password-input-container">
                        <input type="password" id="password" placeholder="Ingresa tu contrase√±a" required>
                        <button type="button" class="password-toggle" id="passwordToggle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength"></div>
                    <div class="validation-message" id="passwordValidation"></div>
                </div>
                
                <div class="form-group" id="displayNameGroup" style="display: none;">
                    <label for="displayName">Nombre (opcional):</label>
                    <input type="text" id="displayName" placeholder="Tu nombre para mostrar">
                </div>
                
                <div class="login-actions">
                    <button type="button" id="loginBtn" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                    </button>
                    <button type="button" id="registerBtn" class="btn-secondary">
                        <i class="fas fa-user-plus"></i> Registrarse
                    </button>
                </div>
                
                <div class="login-links">
                    <button type="button" id="forgotPasswordBtn" class="link-button">
                        ¬øOlvidaste tu contrase√±a?
                    </button>
                    <button type="button" id="toggleModeBtn" class="link-button">
                        Cambiar a modo registro
                    </button>
                </div>
                
                <div class="login-info">
                    <p><i class="fas fa-shield-alt"></i> Tus datos est√°n protegidos con encriptaci√≥n AES-256</p>
                    <p><i class="fas fa-cloud"></i> Sincronizaci√≥n autom√°tica con Firebase</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal de la Aplicaci√≥n -->
    <div id="mainApp" class="main-app" style="display: none;">
        <!-- Header con informaci√≥n del usuario -->
        <header class="header">
            <div class="header-content">
                <div class="app-title">
                    <i class="fas fa-wallet"></i>
                    <h1>JM Budget</h1>
                </div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <div class="sync-status-container">
                        <span id="syncStatus" class="sync-status pending">‚è≥ Pendiente</span>
                        <button id="forceSyncBtn" class="btn-sync" title="Sincronizar ahora">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="syncConfigBtn" class="btn-sync-config" title="Configurar sincronizaci√≥n" onclick="openSyncConfig()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <div class="user-actions">
                        <div class="menu-container">
                            <button id="menuBtn" class="btn-menu" title="Men√∫ de opciones">
                                <i class="fas fa-bars"></i>
                            </button>
                            <div id="menuDropdown" class="menu-dropdown">
                                <button class="menu-item" id="notificationsBtn" title="Notificaciones">
                                    <i class="fas fa-bell"></i>
                                    <span>Notificaciones</span>
                                    <span id="notificationsCount" class="notifications-count">0</span>
                                </button>
                                <button class="menu-item" id="requestNotificationPermissionBtn" title="Solicitar permisos de notificaci√≥n">
                                    <i class="fas fa-bell-slash"></i>
                                    <span>Activar Notificaciones</span>
                                </button>
                                <button class="menu-item" id="installAppBtn" title="Instalar App" style="display: none;">
                                    <i class="fas fa-download"></i>
                                    <span>Instalar App</span>
                                </button>
                                <button class="menu-item" id="menuThemeToggleBtn" title="Cambiar Tema">
                                    <i class="fas fa-moon"></i>
                                    <span>Cambiar Tema</span>
                                </button>
                                <div class="menu-divider"></div>
                                <button class="menu-item" id="collaborationBtn" title="Gestionar colaboraci√≥n">
                                    <i class="fas fa-users"></i>
                                    <span>Gestionar Colaboraci√≥n</span>
                                </button>
                                <button class="menu-item" id="importBtn" title="Importar datos">
                                    <i class="fas fa-file-import"></i>
                                    <span>Importar Datos</span>
                                </button>
                                <button class="menu-item" id="backupBtn" title="Crear backup">
                                    <i class="fas fa-download"></i>
                                    <span>Crear Backup</span>
                                </button>
                                <button class="menu-item" id="resetCategoriesBtn" title="Restablecer categor√≠as por defecto">
                                    <i class="fas fa-refresh"></i>
                                    <span>Restablecer Categor√≠as</span>
                                </button>
                                <button class="menu-item" id="debugTransactionsBtn" title="Depurar transacciones (solo desarrollo)">
                                    <i class="fas fa-bug"></i>
                                    <span>Debug Transacciones</span>
                                </button>
                                <button class="menu-item" id="resetTransactionsBtn" title="Limpiar transacciones (solo desarrollo)">
                                    <i class="fas fa-trash"></i>
                                    <span>Limpiar Transacciones</span>
                                </button>
                                <button class="menu-item" id="clearCacheBtn" title="Limpiar cache (solo desarrollo)">
                                    <i class="fas fa-broom"></i>
                                    <span>Limpiar Cache</span>
                                </button>
                                <button class="menu-item" id="fixDuplicateAccountsBtn" title="Arreglar cuentas duplicadas (solo desarrollo)">
                                    <i class="fas fa-tools"></i>
                                    <span>Arreglar Cuentas Duplicadas</span>
                                </button>
                                <button class="menu-item" id="cloudSyncBtn" title="Configurar sincronizaci√≥n en la nube">
                                    <i class="fas fa-cloud"></i>
                                    <span>Sincronizaci√≥n en la Nube</span>
                                </button>
                                <div class="menu-divider"></div>
                                <button class="menu-item logout-item" id="logoutBtn" title="Cerrar sesi√≥n">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Cerrar Sesi√≥n</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n por pesta√±as -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="reportes">
                <i class="fas fa-chart-bar"></i> Reportes
            </button>
            <button class="tab-btn" data-tab="presupuesto">
                <i class="fas fa-chart-pie"></i> Presupuesto
            </button>
            <button class="tab-btn" data-tab="transacciones">
                <i class="fas fa-exchange-alt"></i> Transacciones
            </button>
            <button class="tab-btn" data-tab="estadisticas">
                <i class="fas fa-analytics"></i> Estad√≠sticas
            </button>
            <button class="tab-btn" data-tab="metas">
                <i class="fas fa-bullseye"></i> Metas
            </button>
            <button class="tab-btn" data-tab="bancos">
                <i class="fas fa-university"></i> Bancos
            </button>
        </nav>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Secci√≥n Reportes -->
            <section id="reportes" class="tab-content active">
                <div class="section-header">
                    <h2>üìä Reportes y An√°lisis</h2>
                    <div class="report-controls">
                        <div class="report-filters">
                            <select id="reportMonth">
                                <option value="">Todos los meses</option>
                            </select>
                            <select id="reportType">
                                <option value="overview">Vista General</option>
                                <option value="trends">Tendencias</option>
                                <option value="categories">An√°lisis por Categor√≠a</option>
                                <option value="comparison">Comparaci√≥n Mensual</option>
                            </select>
                            <button id="exportReportBtn" class="btn-secondary">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3 data-icon="income">Ingresos del Mes</h3>
                        <div class="amount income" id="monthlyIncome">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="expense">Gastos del Mes</h3>
                        <div class="amount expense" id="monthlyExpenses">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="balance">Balance</h3>
                        <div class="amount" id="monthlyBalance">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="trend">Tendencia</h3>
                        <div class="amount" id="monthlyTrend">$0</div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Gastos por Categor√≠a</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Evoluci√≥n Mensual</h3>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Tendencia de Gastos</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>An√°lisis Detallado por Categor√≠a</h3>
                        <canvas id="detailedCategoryChart"></canvas>
                    </div>
                </div>
                
                <div class="report-details">
                    <div class="report-section">
                        <h3>Top 5 Categor√≠as con Mayor Gasto</h3>
                        <div id="topCategoriesList"></div>
                    </div>
                    <div class="report-section">
                        <h3>Comparaci√≥n con Mes Anterior</h3>
                        <div id="monthComparison"></div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Transacciones -->
            <section id="transacciones" class="tab-content">
                <div class="section-header">
                    <h2>Transacciones</h2>
                </div>
                <div class="subtab-navigation">
                    <button class="subtab-btn active" data-subtab="gastos">Gastos</button>
                    <button class="subtab-btn" data-subtab="ingresos">Ingresos</button>
                    <button class="subtab-btn" data-subtab="transferencias">Transferencias</button>
                    <button class="subtab-btn" data-subtab="pagos-tarjetas">Pagos de Tarjetas</button>
                    <button class="btn-primary subtab-action-btn" id="addGastoBtn" style="margin-left:auto;"> <i class="fas fa-plus"></i> Nuevo Gasto</button>
                    <button class="btn-primary subtab-action-btn" id="addIngresoBtn" style="margin-left:auto; display:none;"> <i class="fas fa-plus"></i> Nuevo Ingreso</button>
                    <button class="btn-primary subtab-action-btn" id="addTransferenciaBtn" style="margin-left:auto; display:none;"> <i class="fas fa-exchange-alt"></i> Nueva Transferencia</button>
                    <button class="btn-primary subtab-action-btn" id="addPagoTarjetaBtn" style="margin-left:auto; display:none;"> <i class="fas fa-credit-card"></i> Nuevo Pago</button>
                </div>
                <div class="filters">
                    <select id="monthFilter">
                        <option value="">Todos los meses</option>
                    </select>
                    <select id="categoryFilter">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div id="gastosContainer" class="transactions-subtab active"></div>
                <div id="ingresosContainer" class="transactions-subtab"></div>
                <div id="transferenciasContainer" class="transactions-subtab"></div>
                <div id="pagosTarjetasContainer" class="transactions-subtab"></div>
            </section>

            <!-- Secci√≥n Presupuesto -->
            <section id="presupuesto" class="tab-content">
                <div class="section-header">
                    <div class="budget-controls">
                        <div class="month-selector">
                            <label for="budgetMonth">Mes:</label>
                            <select id="budgetMonth" class="month-select">
                                <option value="">Mes actual</option>
                            </select>
                        </div>
                        <div class="budget-actions">
                            <button class="btn-secondary" id="selectCategoryBtn">
                                <i class="fas fa-list"></i> Elegir Categor√≠a
                            </button>
                            <button class="btn-primary" id="addCategoryBtn">
                                <i class="fas fa-plus"></i> Nueva Categor√≠a
                            </button>
                            <button class="btn-primary" id="addIncomeBtn">
                                <i class="fas fa-plus"></i> Nuevo Ingreso
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3 data-icon="budget">Presupuesto Total</h3>
                        <div class="amount" id="totalBudget">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="spent">Gastado</h3>
                        <div class="amount spent" id="totalSpent">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="remaining">Restante</h3>
                        <div class="amount remaining" id="totalRemaining">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="income">Ingresos</h3>
                        <div class="amount income" id="totalIncomes">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="balance">Balance</h3>
                        <div class="amount" id="totalBalance">$0</div>
                    </div>
                </div>
                
                <div id="incomesContainer"></div>
                
                <h3 id="gastosRecurrentesTitle" style="margin-bottom: 20px; color: #333; font-size: 18px; font-weight: 600;">Gastos Recurrentes</h3>
                <div id="categoriesContainer"></div>
            </section>

            <!-- Secci√≥n Estad√≠sticas Avanzadas -->
            <section id="estadisticas" class="tab-content">
                <div class="section-header">
                    <h2>üìä Estad√≠sticas Avanzadas</h2>
                    <div class="stats-controls">
                        <select id="statsPeriod">
                            <option value="month">Este Mes</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este A√±o</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <button id="exportStatsBtn" class="btn-secondary">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <h3>üí∞ Flujo de Caja</h3>
                        <div class="stats-value" id="cashFlow">$0</div>
                        <div class="stats-change positive" id="cashFlowChange">+0%</div>
                    </div>
                    <div class="stats-card">
                        <h3>üìà Ahorro Mensual</h3>
                        <div class="stats-value" id="monthlySavings">$0</div>
                        <div class="stats-change positive" id="savingsChange">+0%</div>
                    </div>
                    <div class="stats-card">
                        <h3>üéØ Meta de Ahorro</h3>
                        <div class="stats-value" id="savingsGoal">$0</div>
                        <div class="stats-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="savingsProgress"></div>
                            </div>
                            <span id="savingsPercentage">0%</span>
                        </div>
                    </div>
                    <div class="stats-card">
                        <h3>üìä Promedio Diario</h3>
                        <div class="stats-value" id="dailyAverage">$0</div>
                        <div class="stats-subtitle">Gasto promedio por d√≠a</div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>üìà Tendencias de Gastos</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üéØ An√°lisis de Metas</h3>
                        <canvas id="goalsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üìä Distribuci√≥n Temporal</h3>
                        <canvas id="timeDistributionChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üí∞ Comparaci√≥n Mensual</h3>
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
                
                <div class="insights-section">
                    <h3>üí° Insights Inteligentes</h3>
                    <div class="insights-grid" id="insightsContainer">
                        <div class="insight-card">
                            <i class="fas fa-lightbulb"></i>
                            <h4>Gasto Recurrente</h4>
                            <p>Has gastado $0 en servicios recurrentes este mes</p>
                        </div>
                        <div class="insight-card">
                            <i class="fas fa-chart-line"></i>
                            <h4>Tendencia Positiva</h4>
                            <p>Tu gasto ha disminuido un 0% comparado al mes anterior</p>
                        </div>
                        <div class="insight-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h4>Alerta de Presupuesto</h4>
                            <p>Est√°s al 0% de tu presupuesto en la categor√≠a m√°s cara</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Metas y Objetivos -->
            <section id="metas" class="tab-content">
                <div class="section-header">
                    <h2>üéØ Metas y Objetivos Financieros</h2>
                    <button class="btn-primary" id="addGoalBtn">
                        <i class="fas fa-plus"></i> Nueva Meta
                    </button>
                </div>
                
                <div class="goals-overview">
                    <div class="goal-summary-card">
                        <h3>üìä Resumen de Metas</h3>
                        <div class="goal-stats">
                            <div class="goal-stat">
                                <span class="stat-number" id="totalGoals">0</span>
                                <span class="stat-label">Metas Activas</span>
                            </div>
                            <div class="goal-stat">
                                <span class="stat-number" id="completedGoals">0</span>
                                <span class="stat-label">Completadas</span>
                            </div>
                            <div class="goal-stat">
                                <span class="stat-number" id="totalSaved">$0</span>
                                <span class="stat-label">Total Ahorrado</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="goals-container" id="goalsContainer">
                    <div class="no-goals-message">
                        <i class="fas fa-bullseye"></i>
                        <h3>No tienes metas configuradas</h3>
                        <p>Crea tu primera meta financiera para empezar a ahorrar</p>
                        <button class="btn-primary" onclick="showAddGoalModal()">
                            <i class="fas fa-plus"></i> Crear Primera Meta
                        </button>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Bancos -->
            <section id="bancos" class="tab-content">
                <div class="section-header">
                    <h2>üè¶ Gesti√≥n de Bancos</h2>
                    <div class="bank-controls">
                        <button class="btn-primary" id="addBankAccountBtn">
                            <i class="fas fa-plus"></i> Nueva Cuenta
                        </button>
                        <button class="btn-secondary" id="importBankTransactionsBtn">
                            <i class="fas fa-file-import"></i> Importar CSV
                        </button>
                        <button class="btn-secondary" id="reconcileAccountsBtn">
                            <i class="fas fa-sync-alt"></i> Conciliar
                        </button>
                    </div>
                </div>
                
                <!-- Resumen de cuentas -->
                <div class="bank-summary-cards">
                    <div class="summary-card">
                        <h3 data-icon="balance">Balance Total</h3>
                        <div class="amount" id="totalBankBalance">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="accounts">Cuentas Activas</h3>
                        <div class="amount" id="activeAccountsCount">0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="transactions">Transacciones</h3>
                        <div class="amount" id="totalBankTransactions">0</div>
                    </div>
                    <div class="summary-card">
                        <h3 data-icon="reconciled">Conciliadas</h3>
                        <div class="amount" id="reconciledTransactions">0</div>
                    </div>
                </div>
                
                <!-- Lista de cuentas -->
                <div class="bank-accounts-container" id="bankAccountsContainer">
                    <div class="no-accounts-message">
                        <i class="fas fa-university"></i>
                        <h3>No tienes cuentas bancarias configuradas</h3>
                        <p>Agrega tu primera cuenta bancaria para comenzar a gestionar tus finanzas</p>
                        <button class="btn-primary" onclick="openBankAccountModal()">
                            <i class="fas fa-plus"></i> Agregar Primera Cuenta
                        </button>
                    </div>
                </div>
                
                <!-- Transacciones bancarias recientes -->
                <div class="recent-transactions" id="recentBankTransactions" style="display: none;">
                    <h3>üìä Transacciones Recientes</h3>
                    <div class="transactions-list" id="bankTransactionsList"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Nueva/Editar Categor√≠a -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('categoryModal')">&times;</span>
            <h2 id="categoryModalTitle">Nueva Categor√≠a</h2>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Categor√≠a:</label>
                    <div class="select-with-add">
                        <select id="categoryName" required>
                            <option value="">Selecciona una categor√≠a</option>
                        </select>
                        <button type="button" class="btn-icon" id="addCategoryBtn" title="Agregar nueva categor√≠a">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="categorySubcategory">Subcategor√≠a:</label>
                    <div class="select-with-add">
                        <select id="categorySubcategory" required>
                            <option value="">Selecciona una subcategor√≠a</option>
                        </select>
                        <button type="button" class="btn-icon" id="addSubcategoryBtn" title="Agregar nueva subcategor√≠a">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="categoryBudget">Presupuesto Mensual:</label>
                    <input type="number" id="categoryBudget" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="categoryRecurringFrequency">Frecuencia de Recurrencia:</label>
                    <select id="categoryRecurringFrequency" required>
                        <option value="monthly">Mensual</option>
                        <option value="weekly">Semanal</option>
                        <option value="biweekly">Quincenal (cada 15 d√≠as)</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="semiannual">Semestral</option>
                        <option value="annual">Anual</option>
                        <option value="custom">Personalizada</option>
                    </select>
                </div>
                <div class="form-group" id="recurringDateGroup">
                    <label for="categoryRecurringDate">Fecha de Inicio:</label>
                    <input type="date" id="categoryRecurringDate" required>
                </div>
                <div class="form-group" id="customFrequencyGroup" style="display: none;">
                    <label for="categoryCustomDays">Cada cu√°ntos d√≠as:</label>
                    <input type="number" id="categoryCustomDays" min="1" max="365" placeholder="Ej: 30">
                </div>
                <div class="form-group">
                    <label for="categoryColor">Color:</label>
                    <input type="color" id="categoryColor" value="#007aff">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('categoryModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nueva/Editar Transacci√≥n -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transactionModal')">&times;</span>
            <h2 id="transactionModalTitle">Nueva Transacci√≥n</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="transactionDescription">Descripci√≥n:</label>
                    <input type="text" id="transactionDescription" required>
                </div>
                <div class="form-group">
                    <label for="transactionAmount">Monto:</label>
                    <input type="number" id="transactionAmount" step="0.01" required>
                </div>
                <div class="form-group" style="display:none;">
                    <input type="hidden" id="transactionType" value="gasto">
                </div>
                <div class="form-group">
                    <label for="transactionCategory">Categor√≠a:</label>
                    <select id="transactionCategory" required>
                        <option value="">Selecciona una categor√≠a</option>
                    </select>
                </div>
                
                <!-- Campo para seleccionar cuenta bancaria -->
                <div class="form-group" id="accountSelectionGroup">
                    <label for="transactionAccount">Cuenta bancaria:</label>
                    <select id="transactionAccount" required>
                        <option value="">Selecciona una cuenta</option>
                    </select>
                    <small class="form-help">Selecciona desde qu√© cuenta se realiz√≥ el pago</small>
                </div>
                
                <!-- Campo para transferencias -->
                <div class="form-group" id="transferToAccountGroup" style="display: none;">
                    <label for="transferToAccount">Transferir a cuenta:</label>
                    <select id="transferToAccount" required>
                        <option value="">Selecciona cuenta destino</option>
                    </select>
                    <small class="form-help">Selecciona la cuenta que recibir√° la transferencia</small>
                </div>
                
                <div class="form-group">
                    <label for="transactionDate">Fecha:</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label for="transactionComment">Comentario (opcional):</label>
                    <textarea id="transactionComment" placeholder="Agrega un comentario sobre esta transacci√≥n..." rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('transactionModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Seleccionar Categor√≠a Existente -->
    <div id="selectCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('selectCategoryModal')">&times;</span>
            <h2>Elegir Categor√≠a Existente</h2>
            <form id="selectCategoryForm">
                <div class="form-group">
                    <label for="selectCategoryName">Categor√≠a:</label>
                    <select id="selectCategoryName" required>
                        <option value="">Selecciona una categor√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="selectSubcategoryName">Subcategor√≠a:</label>
                    <select id="selectSubcategoryName" required>
                        <option value="">Selecciona una subcategor√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="selectCategoryBudget">Presupuesto Mensual:</label>
                    <input type="number" id="selectCategoryBudget" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="selectCategoryRecurringFrequency">Frecuencia de Recurrencia:</label>
                    <select id="selectCategoryRecurringFrequency" required>
                        <option value="monthly">Mensual</option>
                        <option value="weekly">Semanal</option>
                        <option value="biweekly">Quincenal (cada 15 d√≠as)</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="semiannual">Semestral</option>
                        <option value="annual">Anual</option>
                        <option value="custom">Personalizada</option>
                    </select>
                </div>
                <div class="form-group" id="selectRecurringDateGroup">
                    <label for="selectCategoryRecurringDate">Fecha de Inicio:</label>
                    <input type="date" id="selectCategoryRecurringDate" required>
                </div>
                <div class="form-group" id="selectCustomFrequencyGroup" style="display: none;">
                    <label for="selectCategoryCustomDays">Cada cu√°ntos d√≠as:</label>
                    <input type="number" id="selectCategoryCustomDays" min="1" max="365" placeholder="Ej: 30">
                </div>
                <div class="form-group">
                    <label for="selectCategoryColor">Color:</label>
                    <input type="color" id="selectCategoryColor" value="#007aff">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Agregar al Presupuesto</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('selectCategoryModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gesti√≥n de Colaboraci√≥n -->
    <div id="collaborationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('collaborationModal')">&times;</span>
            <h2>Gesti√≥n de Colaboraci√≥n</h2>
            
            <div class="collaboration-tabs">
                <button class="collab-tab-btn active" data-tab="invite">Invitar</button>
                <button class="collab-tab-btn" data-tab="members">Miembros</button>
                <button class="collab-tab-btn" data-tab="requests">Solicitudes</button>
                <button class="collab-tab-btn" data-tab="history">Historial</button>
            </div>
            
            <!-- Pesta√±a Invitar -->
            <div id="invite-tab" class="collab-tab-content active">
                <div class="form-group">
                    <label for="inviteEmail">Email del colaborador:</label>
                    <input type="email" id="inviteEmail" placeholder="ejemplo@email.com" required>
                </div>
                <div class="form-group">
                    <label for="inviteRole">Rol:</label>
                    <select id="inviteRole" required>
                        <option value="collaborator">Colaborador</option>
                        <option value="viewer">Solo lectura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inviteMessage">Mensaje (opcional):</label>
                    <textarea id="inviteMessage" placeholder="Hola, te invito a colaborar en nuestro presupuesto familiar..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-primary" onclick="sendInvitation()">
                        <i class="fas fa-paper-plane"></i> Enviar Invitaci√≥n
                    </button>
                </div>
            </div>
            
            <!-- Pesta√±a Miembros -->
            <div id="members-tab" class="collab-tab-content">
                <div id="membersList">
                    <p class="no-members">No hay miembros colaborando a√∫n.</p>
                </div>
            </div>
            
            <!-- Pesta√±a Solicitudes -->
            <div id="requests-tab" class="collab-tab-content">
                <div id="requestsList">
                    <p class="no-requests">No hay solicitudes pendientes.</p>
                </div>
            </div>
            
            <!-- Pesta√±a Historial -->
            <div id="history-tab" class="collab-tab-content">
                <div class="history-filters">
                    <select id="historyTypeFilter">
                        <option value="">Todos los cambios</option>
                        <option value="transaction">Transacciones</option>
                        <option value="category">Categor√≠as</option>
                        <option value="collaboration">Colaboraci√≥n</option>
                    </select>
                    <select id="historyUserFilter">
                        <option value="">Todos los usuarios</option>
                    </select>
                </div>
                <div id="historyList">
                    <p class="no-history">No hay cambios registrados a√∫n.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Importaci√≥n -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2>Importar Datos</h2>
            
            <div class="import-tabs">
                <button class="import-tab-btn active" data-tab="instructions">Instrucciones</button>
                <button class="import-tab-btn" data-tab="upload">Subir Archivo</button>
                <button class="import-tab-btn" data-tab="preview">Vista Previa</button>
            </div>
            
            <!-- Pesta√±a Instrucciones -->
            <div id="instructions-tab" class="import-tab-content active">
                <div class="import-instructions">
                    <h3>üìã Formato Requerido</h3>
                    <p>Tu archivo debe tener las siguientes columnas:</p>
                    <ul>
                        <li><strong>Descripci√≥n</strong>: Nombre de la transacci√≥n</li>
                        <li><strong>Monto</strong>: Cantidad (positivo para ingresos, negativo para gastos)</li>
                        <li><strong>Tipo</strong>: "ingreso" o "gasto"</li>
                        <li><strong>Categor√≠a</strong>: Categor√≠a principal</li>
                        <li><strong>Subcategor√≠a</strong>: Subcategor√≠a (opcional)</li>
                        <li><strong>Fecha</strong>: Fecha en formato YYYY-MM-DD</li>
                        <li><strong>Comentario</strong>: Comentario opcional</li>
                    </ul>
                    
                    <h3>üìä Ejemplo de Datos</h3>
                    <div class="example-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th>Monto</th>
                                    <th>Tipo</th>
                                    <th>Categor√≠a</th>
                                    <th>Subcategor√≠a</th>
                                    <th>Fecha</th>
                                    <th>Comentario</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Supermercado</td>
                                    <td>-150.50</td>
                                    <td>gasto</td>
                                    <td>Alimentaci√≥n y Bebidas</td>
                                    <td>Supermercado</td>
                                    <td>2024-01-15</td>
                                    <td>Compra semanal</td>
                                </tr>
                                <tr>
                                    <td>Salario</td>
                                    <td>2500.00</td>
                                    <td>ingreso</td>
                                    <td>Ingresos</td>
                                    <td>Salario</td>
                                    <td>2024-01-01</td>
                                    <td>Pago mensual</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h3>üí° Consejos</h3>
                    <ul>
                        <li>Exporta tu archivo como CSV desde Excel, Numbers o Google Sheets</li>
                        <li>O importa un backup JSON de JM Budget</li>
                        <li>Aseg√∫rate de que las fechas est√©n en formato YYYY-MM-DD</li>
                        <li>Los montos negativos se importar√°n como gastos</li>
                        <li>Las categor√≠as y subcategor√≠as se crear√°n autom√°ticamente si no existen</li>
                    </ul>
                </div>
            </div>
            
            <!-- Pesta√±a Subir Archivo -->
            <div id="upload-tab" class="import-tab-content">
                <div class="upload-area">
                    <div class="file-drop-zone" id="fileDropZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Arrastra tu archivo aqu√≠</h3>
                        <p>o haz clic para seleccionar</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json" style="display: none;">
                    </div>
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file"></i>
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>
                        <button id="processFileBtn" class="btn-primary">
                            <i class="fas fa-cog"></i> Procesar Archivo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pesta√±a Vista Previa -->
            <div id="preview-tab" class="import-tab-content">
                <div class="preview-controls">
                    <div class="preview-stats">
                        <span id="totalRows">Total: 0 filas</span>
                        <span id="validRows">V√°lidas: 0</span>
                        <span id="invalidRows">Con errores: 0</span>
                    </div>
                    <div class="preview-actions">
                        <button id="importDataBtn" class="btn-primary" disabled>
                            <i class="fas fa-download"></i> Importar Datos
                        </button>
                        <button id="cancelImportBtn" class="btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
                <div class="preview-table">
                    <div id="previewContent">
                        <p class="no-preview">Sube un archivo para ver la vista previa</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Ingreso Recurrente -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('incomeModal')">&times;</span>
            <h2 id="incomeModalTitle">Nuevo Ingreso Recurrente</h2>
            <form id="incomeForm">
                <div class="form-group">
                    <label for="incomeName">Nombre del ingreso:</label>
                    <input type="text" id="incomeName" required>
                </div>
                <div class="form-group">
                    <label for="incomeAmount">Monto:</label>
                    <input type="number" id="incomeAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="incomeFrequency">Frecuencia:</label>
                    <select id="incomeFrequency" required>
                        <option value="monthly">Mensual</option>
                        <option value="weekly">Semanal</option>
                        <option value="biweekly">Quincenal (cada 15 d√≠as)</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="semiannual">Semestral</option>
                        <option value="annual">Anual</option>
                        <option value="custom">Personalizada</option>
                    </select>
                </div>
                <div class="form-group" id="incomeDateGroup">
                    <label for="incomeStartDate">Fecha de inicio:</label>
                    <input type="date" id="incomeStartDate" required>
                </div>
                <div class="form-group" id="incomeCustomFrequencyGroup" style="display: none;">
                    <label for="incomeCustomDays">Cada cu√°ntos d√≠as:</label>
                    <input type="number" id="incomeCustomDays" min="1" max="365" placeholder="Ej: 30">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('incomeModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nueva Meta -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('goalModal')">&times;</span>
            <h2 id="goalModalTitle">Nueva Meta Financiera</h2>
            <form id="goalForm">
                <div class="form-group">
                    <label for="goalName">Nombre de la meta:</label>
                    <input type="text" id="goalName" placeholder="Ej: Vacaciones, Auto nuevo, etc." required>
                </div>
                <div class="form-group">
                    <label for="goalTarget">Meta de ahorro:</label>
                    <input type="number" id="goalTarget" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="goalCurrent">Ahorro actual:</label>
                    <input type="number" id="goalCurrent" step="0.01" placeholder="0.00" value="0">
                </div>
                <div class="form-group">
                    <label for="goalDeadline">Fecha objetivo:</label>
                    <input type="date" id="goalDeadline" required>
                </div>
                <div class="form-group">
                    <label for="goalCategory">Categor√≠a:</label>
                    <select id="goalCategory" required>
                        <option value="">Selecciona una categor√≠a</option>
                        <option value="vacaciones">Vacaciones</option>
                        <option value="auto">Autom√≥vil</option>
                        <option value="casa">Casa</option>
                        <option value="emergencia">Fondo de Emergencia</option>
                        <option value="inversion">Inversi√≥n</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="goalColor">Color:</label>
                    <input type="color" id="goalColor" value="#007aff">
                </div>
                <div class="form-group">
                    <label for="goalDescription">Descripci√≥n (opcional):</label>
                    <textarea id="goalDescription" placeholder="Describe tu meta..." rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar Meta</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('goalModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Sincronizaci√≥n en la Nube -->
    <div id="cloudSyncModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cloudSyncModal')">&times;</span>
            <h2>‚òÅÔ∏è Sincronizaci√≥n en la Nube</h2>
            
            <!-- Estado de conexi√≥n -->
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Verificando conexi√≥n...</span>
                </div>
                <div class="last-sync-info">
                    <small>√öltima sincronizaci√≥n: <span id="lastSyncTime">Nunca</span></small>
                </div>
            </div>
            
            <!-- Pesta√±as simplificadas -->
            <div class="tab-container">
                <button class="tab-button active" onclick="showTab('sync')">Sincronizar</button>
                <button class="tab-button" onclick="showTab('restore')">Restaurar</button>
                <button class="tab-button" onclick="showTab('history')">Historial</button>
            </div>
            
            <!-- Pesta√±a de Sincronizaci√≥n -->
            <div id="sync-tab" class="tab-content active">
                <h3>üì§ Sincronizar Datos</h3>
                <div class="sync-options">
                    <div class="sync-option">
                        <input type="checkbox" id="autoSync" checked>
                        <label for="autoSync">Sincronizaci√≥n autom√°tica</label>
                        <small>Los datos se sincronizan autom√°ticamente al guardar</small>
                    </div>
                    <div class="sync-option">
                        <input type="checkbox" id="syncTransactions" checked>
                        <label for="syncTransactions">Transacciones</label>
                    </div>
                    <div class="sync-option">
                        <input type="checkbox" id="syncCategories" checked>
                        <label for="syncCategories">Categor√≠as</label>
                    </div>
                    <div class="sync-option">
                        <input type="checkbox" id="syncBudgets" checked>
                        <label for="syncBudgets">Presupuestos</label>
                    </div>
                </div>
                <div class="sync-actions">
                    <button onclick="syncToCloud()" class="btn btn-primary">
                        <span class="btn-icon">üì§</span>
                        Sincronizar Ahora
                    </button>
                    <button onclick="syncFromCloud()" class="btn btn-secondary">
                        <span class="btn-icon">üì•</span>
                        Sincronizar desde la Nube
                    </button>
                </div>
                <div class="sync-progress" id="syncProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="progressText">Sincronizando...</span>
                </div>
            </div>
            
            <!-- Pesta√±a de Restauraci√≥n -->
            <div id="restore-tab" class="tab-content">
                <h3>üîÑ Restaurar Datos</h3>
                <div class="restore-warning">
                    <p>‚ö†Ô∏è <strong>Advertencia:</strong> Restaurar datos sobrescribir√° los datos locales actuales.</p>
                </div>
                <div class="restore-options">
                    <div class="restore-option">
                        <input type="radio" id="restoreAll" name="restoreType" value="all" checked>
                        <label for="restoreAll">Restaurar todo</label>
                    </div>
                    <div class="restore-option">
                        <input type="radio" id="restoreSelective" name="restoreType" value="selective">
                        <label for="restoreSelective">Restauraci√≥n selectiva</label>
                    </div>
                </div>
                <div class="restore-actions">
                    <button onclick="restoreFromCloud()" class="btn btn-warning">
                        <span class="btn-icon">üîÑ</span>
                        Restaurar desde la Nube
                    </button>
                </div>
            </div>
            
            <!-- Pesta√±a de Historial -->
            <div id="history-tab" class="tab-content">
                <h3>üìã Historial de Sincronizaci√≥n</h3>
                <div class="sync-history" id="syncHistory">
                    <div class="history-item">
                        <span class="history-date">Cargando historial...</span>
                    </div>
                </div>
                <button onclick="loadSyncHistory()" class="btn btn-secondary">Actualizar Historial</button>
            </div>
        </div>
    </div>

    <!-- Script principal -->
    <script src="storage.js"></script>
    <script src="cloud-services.js"></script>
    <script src="script.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado exitosamente:', registration.scope);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nueva versi√≥n disponible
                                    if (confirm('Hay una nueva versi√≥n disponible. ¬øQuieres actualizar ahora?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                        
                        // Funci√≥n para limpiar cache manualmente
                        window.clearAppCache = function() {
                            if ('caches' in window) {
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            console.log('Eliminando cache:', cacheName);
                                            return caches.delete(cacheName);
                                        })
                                    );
                                }).then(() => {
                                    console.log('Cache limpiado exitosamente');
                                    window.location.reload();
                                });
                            }
                        };
                        
                        // En desarrollo, limpiar cache autom√°ticamente si hay cambios
                        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                            // Verificar si hay una nueva versi√≥n del Service Worker
                            registration.update();
                        }
                    })
                    .catch(error => {
                        console.error('Error al registrar Service Worker:', error);
                    });
            });
        } else {
            console.log('Service Worker no disponible (protocolo file:// o sin HTTPS)');
        }
        
        // Detectar si la app est√° instalada
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que se muestre autom√°ticamente
            e.preventDefault();
            
            // Guardar el evento para mostrarlo m√°s tarde
            window.deferredPrompt = e;
            
            // Mostrar bot√≥n de instalaci√≥n personalizado si existe
            const installButton = document.getElementById('installAppBtn');
            if (installButton) {
                installButton.style.display = 'block';
                installButton.addEventListener('click', () => {
                    window.deferredPrompt.prompt();
                    window.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usuario acept√≥ instalar la app');
                            // Ocultar el bot√≥n despu√©s de la instalaci√≥n
                            installButton.style.display = 'none';
                        }
                        window.deferredPrompt = null;
                    });
                });
            }
        });
        
        // Detectar si la app ya est√° instalada
        window.addEventListener('appinstalled', (e) => {
            console.log('App instalada exitosamente');
            const installButton = document.getElementById('installAppBtn');
            if (installButton) {
                installButton.style.display = 'none';
            }
        });
    </script>
    
    <!-- Script de carga y manejo de errores -->
    <script>
        // Verificar que la aplicaci√≥n se cargue correctamente
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ JM Budget cargado correctamente');
            
            // Verificar carga de CSS
            const cssFiles = document.styleSheets;
            console.log('üìÅ Archivos CSS cargados:', cssFiles.length);
            for (let i = 0; i < cssFiles.length; i++) {
                try {
                    console.log(`CSS ${i}:`, cssFiles[i].href || 'inline styles');
                } catch (e) {
                    console.warn(`CSS ${i}: Error al acceder - posible CORS`);
                }
            }
            
            // Verificar dependencias cr√≠ticas
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js no se carg√≥ correctamente');
                // Mostrar mensaje al usuario
                const warning = document.createElement('div');
                warning.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9500;color:white;padding:10px;border-radius:8px;z-index:10000;';
                warning.innerHTML = '‚ö†Ô∏è Algunas funciones pueden no estar disponibles';
                document.body.appendChild(warning);
                setTimeout(() => warning.remove(), 5000);
            }
            
            // Verificar localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                console.log('‚úÖ localStorage disponible');
            } catch (e) {
                console.error('‚ùå localStorage no disponible');
                alert('Error: localStorage no est√° disponible. La aplicaci√≥n no puede guardar datos.');
            }
            
            // Verificar conexi√≥n a internet para CDNs
            if (!navigator.onLine) {
                console.warn('‚ö†Ô∏è Sin conexi√≥n a internet - algunas funciones pueden no estar disponibles');
            }
        });
        
        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('‚ùå Error en la aplicaci√≥n:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });
        
        // Manejo de errores de promesas no capturadas
        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Promesa rechazada no manejada:', e.reason);
        });
        
        // Manejo de errores de recursos no cargados
        window.addEventListener('load', function() {
            console.log('üì± Aplicaci√≥n lista para usar');
        });
    </script>
    
    <!-- Modal para Nueva/Editar Cuenta Bancaria -->
    <div id="bankAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankAccountModal')">&times;</span>
            <h2 id="bankAccountModalTitle">Nueva Cuenta Bancaria</h2>
            <form id="bankAccountForm">
                <div class="form-group">
                    <label for="bankAccountName">Nombre de la cuenta:</label>
                    <input type="text" id="bankAccountName" placeholder="Ej: Cuenta Corriente Principal" required>
                </div>
                <div class="form-group">
                    <label for="bankAccountType">Tipo de cuenta:</label>
                    <select id="bankAccountType" required onchange="handleAccountTypeChange()">
                        <option value="">Selecciona el tipo</option>
                        <option value="checking">Cuenta Corriente</option>
                        <option value="savings">Cuenta de Ahorros</option>
                        <option value="credit">Tarjeta de Cr√©dito</option>
                        <option value="investment">Cuenta de Inversi√≥n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bankName">Banco:</label>
                    <input type="text" id="bankName" placeholder="Ej: Banco Nacional" required>
                </div>
                <div class="form-group">
                    <label for="bankAccountNumber">N√∫mero de cuenta (opcional):</label>
                    <input type="text" id="bankAccountNumber" placeholder="√öltimos 4 d√≠gitos">
                </div>
                <div class="form-group">
                    <label for="bankAccountBalance">Balance inicial:</label>
                    <input type="number" id="bankAccountBalance" step="0.01" placeholder="0.00" value="0">
                </div>
                
                <!-- Campos espec√≠ficos para tarjetas de cr√©dito -->
                <div id="creditCardFields" style="display: none;">
                    <div class="form-group">
                        <label for="creditLimit">L√≠mite de cr√©dito:</label>
                        <input type="number" id="creditLimit" step="0.01" placeholder="0.00" value="0">
                    </div>
                    <div class="form-group">
                        <label for="cutoffDate">Fecha de corte:</label>
                        <input type="date" id="cutoffDate">
                    </div>
                    <div class="form-group">
                        <label for="paymentDueDate">Fecha l√≠mite de pago:</label>
                        <input type="date" id="paymentDueDate">
                    </div>
                    <div class="form-group">
                        <label for="minimumPayment">Pago m√≠nimo:</label>
                        <input type="number" id="minimumPayment" step="0.01" placeholder="0.00" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="bankAccountCurrency">Moneda:</label>
                    <select id="bankAccountCurrency" required>
                        <option value="DOP" selected>DOP - Peso Dominicano (RD$)</option>
                        <option value="USD">USD - D√≥lar Estadounidense</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="COP">COP - Peso Colombiano</option>
                        <option value="MXN">MXN - Peso Mexicano</option>
                        <option value="ARS">ARS - Peso Argentino</option>
                        <option value="CLP">CLP - Peso Chileno</option>
                        <option value="PEN">PEN - Sol Peruano</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bankAccountColor">Color:</label>
                    <input type="color" id="bankAccountColor" value="#007aff">
                </div>
                <div class="form-group">
                    <label for="bankAccountNotes">Notas (opcional):</label>
                    <textarea id="bankAccountNotes" placeholder="Informaci√≥n adicional sobre la cuenta..." rows="3"></textarea>
                </div>
                
                <!-- Campos adicionales -->
                <div class="form-group">
                    <label for="accountStatus">Estado de la cuenta:</label>
                    <select id="accountStatus">
                        <option value="active" selected>Activa</option>
                        <option value="inactive">Inactiva</option>
                        <option value="suspended">Suspendida</option>
                        <option value="closed">Cerrada</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accountHolder">Titular de la cuenta:</label>
                    <input type="text" id="accountHolder" placeholder="Nombre del titular">
                </div>
                
                <div class="form-group">
                    <label for="accountEmail">Email asociado:</label>
                    <input type="email" id="accountEmail" placeholder="email@ejemplo.com">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar Cuenta</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('bankAccountModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Pagos de Tarjetas de Cr√©dito -->
    <div id="pagoTarjetaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('pagoTarjetaModal')">&times;</span>
            <h2>üí≥ Pago de Tarjeta de Cr√©dito</h2>
            <form id="pagoTarjetaForm">
                <div class="form-group">
                    <label for="pagoTarjetaDescripcion">Descripci√≥n del pago:</label>
                    <input type="text" id="pagoTarjetaDescripcion" placeholder="Ej: Pago tarjeta Visa, Pago m√≠nimo, etc." required>
                </div>
                
                <div class="form-group">
                    <label for="pagoTarjetaMonto">Monto a pagar:</label>
                    <input type="number" id="pagoTarjetaMonto" step="0.01" placeholder="0.00" required>
                </div>
                
                <div class="form-group">
                    <label for="pagoTarjetaCuentaOrigen">Cuenta de origen:</label>
                    <select id="pagoTarjetaCuentaOrigen" required>
                        <option value="">Selecciona la cuenta desde donde pagar√°s</option>
                    </select>
                    <small class="form-help">Selecciona la cuenta bancaria desde donde har√°s el pago</small>
                </div>
                
                <div class="form-group">
                    <label for="pagoTarjetaDestino">Tarjeta de cr√©dito:</label>
                    <select id="pagoTarjetaDestino" required>
                        <option value="">Selecciona la tarjeta a pagar</option>
                    </select>
                    <small class="form-help">Selecciona la tarjeta de cr√©dito que vas a pagar</small>
                </div>
                
                <div class="form-group">
                    <label for="pagoTarjetaFecha">Fecha del pago:</label>
                    <input type="date" id="pagoTarjetaFecha" required>
                </div>
                
                <div class="form-group">
                    <label for="pagoTarjetaComentario">Comentario (opcional):</label>
                    <textarea id="pagoTarjetaComentario" placeholder="Informaci√≥n adicional sobre el pago..." rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Realizar Pago</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('pagoTarjetaModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Importar Transacciones Bancarias -->
    <div id="importBankTransactionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importBankTransactionsModal')">&times;</span>
            <h2>üì• Importar Transacciones Bancarias</h2>
            
            <div class="import-steps">
                <div class="step active" id="step1">
                    <h3>1. Seleccionar Cuenta</h3>
                    <div class="form-group">
                        <label for="importAccountSelect">Cuenta bancaria:</label>
                        <select id="importAccountSelect" required>
                            <option value="">Selecciona una cuenta</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="nextStep(2)">Siguiente</button>
                </div>
                
                <div class="step" id="step2">
                    <h3>2. Subir Archivo CSV</h3>
                    <div class="file-upload-area">
                        <div class="file-drop-zone" id="bankFileDropZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Arrastra tu archivo CSV aqu√≠</h3>
                            <p>o haz clic para seleccionar</p>
                            <input type="file" id="bankFileInput" accept=".csv" style="display: none;">
                        </div>
                        <div class="file-info" id="bankFileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-csv"></i>
                                <span id="bankFileName"></span>
                                <span id="bankFileSize"></span>
                            </div>
                            <button id="processBankFileBtn" class="btn-primary">
                                <i class="fas fa-cog"></i> Procesar Archivo
                            </button>
                        </div>
                    </div>
                    <div class="step-actions">
                        <button class="btn-secondary" onclick="prevStep(1)">Anterior</button>
                    </div>
                </div>
                
                <div class="step" id="step3">
                    <h3>3. Revisar y Confirmar</h3>
                    <div class="import-preview">
                        <div class="preview-stats">
                            <span id="bankTotalRows">Total: 0 filas</span>
                            <span id="bankValidRows">V√°lidas: 0</span>
                            <span id="bankInvalidRows">Con errores: 0</span>
                        </div>
                        <div class="preview-table">
                            <div id="bankPreviewContent">
                                <p class="no-preview">Sube un archivo para ver la vista previa</p>
                            </div>
                        </div>
                    </div>
                    <div class="step-actions">
                        <button class="btn-secondary" onclick="prevStep(2)">Anterior</button>
                        <button id="confirmBankImportBtn" class="btn-primary" disabled>
                            <i class="fas fa-check"></i> Confirmar Importaci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Sincronizaci√≥n -->
    <div id="syncConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud"></i> Configuraci√≥n de Sincronizaci√≥n</h3>
                <button class="close-btn" onclick="closeModal('syncConfigModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Estrategia de Resoluci√≥n de Conflictos:</label>
                    <select id="conflictResolution">
                        <option value="smart-merge">Fusi√≥n Inteligente (Recomendado)</option>
                        <option value="server-wins">Servidor Gana</option>
                        <option value="client-wins">Cliente Gana</option>
                        <option value="manual">Manual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Frecuencia de Sincronizaci√≥n:</label>
                    <select id="syncFrequency">
                        <option value="300000">Cada 5 minutos</option>
                        <option value="600000">Cada 10 minutos</option>
                        <option value="1800000">Cada 30 minutos</option>
                        <option value="3600000">Cada hora</option>
                    </select>
                </div>
                <div class="sync-info">
                    <p><i class="fas fa-info-circle"></i> La sincronizaci√≥n autom√°tica mantiene tus datos actualizados en todos tus dispositivos.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="restoreDefaultSyncConfig()">Restaurar</button>
                <button class="btn-secondary" onclick="closeModal('syncConfigModal')">Cancelar</button>
                <button class="btn-primary" onclick="saveSyncConfig()">Guardar</button>
            </div>
        </div>
    </div>
</body>
</html> 