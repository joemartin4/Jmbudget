<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Filtros - JM Budget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        .debug-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .transaction-item {
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .filter-controls select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug Filtros de Fecha - JM Budget</h1>
        <p>Esta herramienta verifica que los filtros de fecha funcionen correctamente y fuerza la actualizaci√≥n del cache.</p>
        
        <div class="debug-section">
            <h3>üîÑ Forzar Actualizaci√≥n de Cache</h3>
            <button class="btn btn-warning" onclick="forceCacheClear()">Limpiar Cache del Navegador</button>
            <button class="btn btn-success" onclick="reloadWithCacheBust()">Recargar con Cache Bust</button>
            <button class="btn" onclick="checkScriptVersion()">Verificar Versi√≥n del Script</button>
        </div>
        
        <div class="debug-section">
            <h3>üìÖ Test de Filtros de Fecha</h3>
            
            <div class="filter-controls">
                <label>Filtrar por mes:</label>
                <select id="monthFilter" onchange="testFilter()">
                    <option value="">Todos los meses</option>
                    <option value="2025-08">Agosto 2025</option>
                    <option value="2025-07">Julio 2025</option>
                    <option value="2025-06">Junio 2025</option>
                    <option value="2025-05">Mayo 2025</option>
                </select>
                <button class="btn" onclick="clearFilter()">Limpiar Filtro</button>
            </div>
            
            <div id="filterResults" class="log">
                <p>Esperando filtro...</p>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>üìä Transacciones de Prueba</h3>
            <div id="testTransactions" class="log">
                <p>Cargando transacciones...</p>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>üîß Debug de Funci√≥n createLocalDate</h3>
            <button class="btn" onclick="testCreateLocalDate()">Probar createLocalDate</button>
            <div id="createLocalDateResults" class="log">
                <p>Esperando test...</p>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>üìù Log de Debug</h3>
            <div id="debugLog" class="log">
                <p>Iniciando debug...</p>
            </div>
            <button class="btn btn-warning" onclick="clearDebugLog()">Limpiar Log</button>
        </div>
        
        <div class="debug-section">
            <h3>üéØ Acciones de Debug</h3>
            <button class="btn btn-success" onclick="runAllDebugTests()">Ejecutar Todos los Tests</button>
            <button class="btn btn-danger" onclick="simulateFilterProblem()">Simular Problema de Filtro</button>
            <button class="btn" onclick="checkCurrentFilterState()">Verificar Estado Actual</button>
        </div>
    </div>

    <script>
        // Datos de prueba que simulan el problema
        let testTransactions = [
            {
                id: 1,
                description: 'Tu Quipe',
                amount: -185.00,
                type: 'gasto',
                category: 'Alimentaci√≥n y Bebidas',
                accountId: 'TC Qik',
                date: '2025-08-02', // 2 de agosto de 2025
                comment: 'Compra de comida'
            },
            {
                id: 2,
                description: 'Gasolina',
                amount: -1200.00,
                type: 'gasto',
                category: 'Transporte',
                accountId: 'Cuenta Principal',
                date: '2025-07-15', // 15 de julio de 2025
                comment: 'Llenado de tanque'
            },
            {
                id: 3,
                description: 'Salario',
                amount: 50000.00,
                type: 'ingreso',
                category: 'Ingresos',
                accountId: 'Cuenta Principal',
                date: '2025-07-01', // 1 de julio de 2025
                comment: 'Pago mensual'
            },
            {
                id: 4,
                description: 'Supermercado',
                amount: -2500.00,
                type: 'gasto',
                category: 'Alimentaci√≥n y Bebidas',
                accountId: 'Cuenta Principal',
                date: '2025-06-20', // 20 de junio de 2025
                comment: 'Compra semanal'
            }
        ];
        
        // Funci√≥n auxiliar para crear fechas de manera consistente (copiada del script principal)
        function createLocalDate(dateString) {
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day); // month - 1 porque los meses van de 0-11
            } else {
                return new Date(dateString);
            }
        }
        
        // Funci√≥n para agregar log
        function addLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Funci√≥n para limpiar log
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '<p>Log limpiado...</p>';
        }
        
        // Funci√≥n para forzar limpieza de cache
        function forceCacheClear() {
            addLog('üîÑ Forzando limpieza de cache...', 'warning');
            
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            addLog(`üóëÔ∏è Eliminando cache: ${cacheName}`, 'warning');
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    addLog('‚úÖ Cache limpiado exitosamente', 'success');
                    addLog('üîÑ Recargando p√°gina...', 'info');
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1000);
                });
            } else {
                addLog('‚ö†Ô∏è Cache API no disponible', 'warning');
                addLog('üîÑ Recargando p√°gina con par√°metros de cache bust...', 'info');
                window.location.reload(true);
            }
        }
        
        // Funci√≥n para recargar con cache bust
        function reloadWithCacheBust() {
            addLog('üîÑ Recargando con cache bust...', 'info');
            const timestamp = new Date().getTime();
            window.location.href = `${window.location.pathname}?v=${timestamp}`;
        }
        
        // Funci√≥n para verificar versi√≥n del script
        function checkScriptVersion() {
            addLog('üîç Verificando versi√≥n del script...', 'info');
            
            const scripts = document.querySelectorAll('script[src*="script.js"]');
            scripts.forEach(script => {
                addLog(`üìÑ Script encontrado: ${script.src}`, 'info');
            });
            
            // Verificar si la funci√≥n createLocalDate est√° disponible
            if (typeof createLocalDate === 'function') {
                addLog('‚úÖ Funci√≥n createLocalDate disponible', 'success');
            } else {
                addLog('‚ùå Funci√≥n createLocalDate NO disponible', 'error');
            }
        }
        
        // Funci√≥n para probar filtros
        function testFilter() {
            addLog('üìÖ Probando filtros de fecha...', 'info');
            
            const monthFilter = document.getElementById('monthFilter').value;
            
            if (!monthFilter) {
                addLog('‚ö†Ô∏è No hay filtro seleccionado', 'warning');
                showAllTransactions();
                return;
            }
            
            addLog(`üîç Aplicando filtro: ${monthFilter}`, 'info');
            
            // Usar createLocalDate para comparar fechas correctamente
            const filterYear = parseInt(monthFilter.split('-')[0]);
            const filterMonth = parseInt(monthFilter.split('-')[1]) - 1; // Meses van de 0-11
            
            addLog(`üìä Filtro configurado: A√±o ${filterYear}, Mes ${filterMonth + 1}`, 'info');
            
            const filteredTransactions = testTransactions.filter(t => {
                const transactionDate = createLocalDate(t.date);
                const matches = transactionDate.getFullYear() === filterYear && 
                               transactionDate.getMonth() === filterMonth;
                
                addLog(`üìù Transacci√≥n ${t.description} (${t.date}): A√±o ${transactionDate.getFullYear()}, Mes ${transactionDate.getMonth() + 1} - Coincide: ${matches}`, 'info');
                
                return matches;
            });
            
            addLog(`üìä Transacciones filtradas: ${filteredTransactions.length}`, 'success');
            
            // Mostrar resultados
            const resultsDiv = document.getElementById('filterResults');
            if (filteredTransactions.length > 0) {
                resultsDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Filtro aplicado correctamente</strong><br>
                        <strong>Filtro:</strong> ${monthFilter}<br>
                        <strong>Transacciones encontradas:</strong> ${filteredTransactions.length}<br><br>
                        <strong>Transacciones:</strong><br>
                        ${filteredTransactions.map(t => 
                            `‚Ä¢ ${t.description} - ${t.date} - $${t.amount}`
                        ).join('<br>')}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="warning">
                        <strong>‚ö†Ô∏è No se encontraron transacciones</strong><br>
                        <strong>Filtro:</strong> ${monthFilter}<br>
                        <strong>Transacciones disponibles:</strong> ${testTransactions.length}
                    </div>
                `;
            }
        }
        
        // Funci√≥n para limpiar filtro
        function clearFilter() {
            document.getElementById('monthFilter').value = '';
            document.getElementById('filterResults').innerHTML = '<p>Filtro limpiado...</p>';
            showAllTransactions();
            addLog('üßπ Filtro limpiado', 'info');
        }
        
        // Funci√≥n para mostrar todas las transacciones
        function showAllTransactions() {
            const transactionsDiv = document.getElementById('testTransactions');
            transactionsDiv.innerHTML = `
                <div class="success">
                    <strong>üìä Todas las transacciones de prueba:</strong><br><br>
                    ${testTransactions.map(t => 
                        `<div class="transaction-item">
                            <strong>${t.description}</strong><br>
                            Fecha: ${t.date} | Monto: $${t.amount} | Categor√≠a: ${t.category}
                        </div>`
                    ).join('')}
                </div>
            `;
        }
        
        // Funci√≥n para probar createLocalDate
        function testCreateLocalDate() {
            addLog('üîß Probando funci√≥n createLocalDate...', 'info');
            
            const testDates = ['2025-08-02', '2025-07-15', '2025-06-20'];
            const resultsDiv = document.getElementById('createLocalDateResults');
            
            let results = '<div class="success"><strong>‚úÖ Test de createLocalDate:</strong><br><br>';
            
            testDates.forEach(dateStr => {
                const localDate = createLocalDate(dateStr);
                results += `
                    <strong>Fecha original:</strong> ${dateStr}<br>
                    <strong>Fecha procesada:</strong> ${localDate.toISOString()}<br>
                    <strong>A√±o:</strong> ${localDate.getFullYear()}, <strong>Mes:</strong> ${localDate.getMonth() + 1}, <strong>D√≠a:</strong> ${localDate.getDate()}<br>
                    <hr>
                `;
                
                addLog(`üìÖ ${dateStr} ‚Üí A√±o: ${localDate.getFullYear()}, Mes: ${localDate.getMonth() + 1}, D√≠a: ${localDate.getDate()}`, 'info');
            });
            
            results += '</div>';
            resultsDiv.innerHTML = results;
            
            addLog('‚úÖ Test de createLocalDate completado', 'success');
        }
        
        // Funci√≥n para simular problema de filtro
        function simulateFilterProblem() {
            addLog('üêõ Simulando problema de filtro...', 'warning');
            
            const monthFilter = '2025-07'; // Julio 2025
            addLog(`üîç Filtro: ${monthFilter}`, 'info');
            
            // Simular el problema original (usando startsWith)
            const wrongFiltered = testTransactions.filter(t => t.date.startsWith(monthFilter));
            addLog(`‚ùå Filtro incorrecto (startsWith): ${wrongFiltered.length} transacciones`, 'error');
            
            // Mostrar el filtro correcto
            const filterYear = parseInt(monthFilter.split('-')[0]);
            const filterMonth = parseInt(monthFilter.split('-')[1]) - 1;
            
            const correctFiltered = testTransactions.filter(t => {
                const transactionDate = createLocalDate(t.date);
                return transactionDate.getFullYear() === filterYear && 
                       transactionDate.getMonth() === filterMonth;
            });
            
            addLog(`‚úÖ Filtro correcto (createLocalDate): ${correctFiltered.length} transacciones`, 'success');
            
            const resultsDiv = document.getElementById('filterResults');
            resultsDiv.innerHTML = `
                <div class="error">
                    <strong>üêõ Problema Simulado:</strong><br>
                    <strong>Filtro:</strong> ${monthFilter} (Julio 2025)<br>
                    <strong>Filtro incorrecto (startsWith):</strong> ${wrongFiltered.length} transacciones<br>
                    <strong>Filtro correcto (createLocalDate):</strong> ${correctFiltered.length} transacciones<br><br>
                    <strong>Transacciones con filtro correcto:</strong><br>
                    ${correctFiltered.map(t => 
                        `‚Ä¢ ${t.description} - ${t.date} - $${t.amount}`
                    ).join('<br>')}
                </div>
            `;
        }
        
        // Funci√≥n para verificar estado actual
        function checkCurrentFilterState() {
            addLog('üîç Verificando estado actual...', 'info');
            
            const monthFilter = document.getElementById('monthFilter').value;
            addLog(`üìÖ Filtro actual: ${monthFilter || 'Ninguno'}`, 'info');
            
            addLog(`üìä Total de transacciones: ${testTransactions.length}`, 'info');
            
            testTransactions.forEach(t => {
                const localDate = createLocalDate(t.date);
                addLog(`üìù ${t.description}: ${t.date} ‚Üí A√±o ${localDate.getFullYear()}, Mes ${localDate.getMonth() + 1}`, 'info');
            });
        }
        
        // Funci√≥n para ejecutar todos los tests
        function runAllDebugTests() {
            addLog('üöÄ Ejecutando todos los tests de debug...', 'info');
            
            setTimeout(() => checkScriptVersion(), 100);
            setTimeout(() => testCreateLocalDate(), 200);
            setTimeout(() => showAllTransactions(), 300);
            setTimeout(() => simulateFilterProblem(), 400);
            
            setTimeout(() => {
                addLog('üéâ Todos los tests de debug completados', 'success');
            }, 1000);
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Debug de filtros iniciado', 'info');
            showAllTransactions();
            addLog('üìù Transacciones de prueba cargadas', 'success');
        });
    </script>
</body>
</html> 