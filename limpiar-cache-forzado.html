<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiar Cache Forzado - JM Budget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 4px;
            cursor: pointer;
            margin: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .btn:hover {
            background-color: #c82333;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Limpiar Cache Forzado - JM Budget</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è ADVERTENCIA</h3>
            <p>Esta herramienta limpiar√° completamente el cache del navegador y recargar√° la aplicaci√≥n.</p>
            <p><strong>Se perder√°n temporalmente:</strong></p>
            <ul>
                <li>Datos de formularios no guardados</li>
                <li>Pesta√±as abiertas</li>
                <li>Configuraciones temporales</li>
            </ul>
            <p><strong>NO se perder√°n:</strong></p>
            <ul>
                <li>Datos guardados en localStorage</li>
                <li>Configuraciones permanentes</li>
                <li>Transacciones y categor√≠as</li>
            </ul>
        </div>
        
        <div class="log" id="log">
            <p>Listo para limpiar cache...</p>
        </div>
        
        <button class="btn" onclick="limpiarCacheCompleto()">
            üóëÔ∏è LIMPIAR CACHE COMPLETO Y RECARGAR
        </button>
        
        <div id="resultado"></div>
    </div>

    <script>
        function addLog(message) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        function showResult(content, type = 'success') {
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerHTML = `<div class="${type}">${content}</div>`;
        }
        
        async function limpiarCacheCompleto() {
            addLog('üöÄ Iniciando limpieza completa de cache...');
            
            try {
                // 1. Limpiar Cache API
                addLog('üóëÔ∏è Limpiando Cache API...');
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    addLog(`üìä Encontrados ${cacheNames.length} caches`);
                    
                    for (const cacheName of cacheNames) {
                        addLog(`üóëÔ∏è Eliminando cache: ${cacheName}`);
                        await caches.delete(cacheName);
                    }
                    addLog('‚úÖ Cache API limpiado');
                }
                
                // 2. Desregistrar Service Workers
                addLog('üîß Desregistrando Service Workers...');
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    addLog(`üìä Encontrados ${registrations.length} Service Workers`);
                    
                    for (const registration of registrations) {
                        addLog(`üîß Desregistrando: ${registration.scope}`);
                        await registration.unregister();
                    }
                    addLog('‚úÖ Service Workers desregistrados');
                }
                
                // 3. Limpiar IndexedDB
                addLog('üíæ Limpiando IndexedDB...');
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            addLog(`üóëÔ∏è Eliminando IndexedDB: ${db.name}`);
                            indexedDB.deleteDatabase(db.name);
                        }
                        addLog('‚úÖ IndexedDB limpiado');
                    } catch (e) {
                        addLog(`‚ö†Ô∏è Error limpiando IndexedDB: ${e.message}`);
                    }
                }
                
                // 4. Limpiar SessionStorage
                addLog('üóëÔ∏è Limpiando SessionStorage...');
                sessionStorage.clear();
                addLog('‚úÖ SessionStorage limpiado');
                
                // 5. Limpiar localStorage temporal (solo claves de cache)
                addLog('üíæ Verificando localStorage...');
                const keysToKeep = ['userData', 'categories', 'transactions', 'bankAccounts', 'notifications', 'goals', 'incomes'];
                const allKeys = Object.keys(localStorage);
                const keysToRemove = allKeys.filter(key => !keysToKeep.includes(key));
                
                if (keysToRemove.length > 0) {
                    addLog(`üóëÔ∏è Limpiando ${keysToRemove.length} claves de cache de localStorage`);
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                }
                
                // 6. Forzar recarga con par√°metros de cache bust
                addLog('üîÑ Preparando recarga forzada...');
                const timestamp = new Date().getTime();
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('v', timestamp);
                currentUrl.searchParams.set('cache_bust', 'true');
                currentUrl.searchParams.set('force_reload', 'true');
                
                showResult(`
                    <h3>‚úÖ Cache Limpiado Exitosamente</h3>
                    <p><strong>Timestamp:</strong> ${timestamp}</p>
                    <p><strong>URL de recarga:</strong> ${currentUrl.toString()}</p>
                    <p>La aplicaci√≥n se recargar√° autom√°ticamente en 3 segundos...</p>
                    <p><strong>Despu√©s de la recarga:</strong></p>
                    <ol>
                        <li>Ir a la secci√≥n "Transacciones"</li>
                        <li>Probar filtros de fecha (julio, agosto, etc.)</li>
                        <li>Verificar que funcionen correctamente</li>
                    </ol>
                `, 'success');
                
                addLog('‚è∞ Esperando 3 segundos antes de recargar...');
                
                setTimeout(() => {
                    addLog('üîÑ Recargando aplicaci√≥n...');
                    window.location.href = currentUrl.toString();
                }, 3000);
                
            } catch (error) {
                addLog(`‚ùå Error durante la limpieza: ${error.message}`);
                showResult(`
                    <h3>‚ùå Error en la Limpieza</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Intenta recargar manualmente con Ctrl+Shift+R</p>
                `, 'warning');
            }
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Herramienta de limpieza de cache iniciada');
            addLog('üìä URL actual: ' + window.location.href);
        });
    </script>
</body>
</html> 